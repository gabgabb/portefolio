name: CI Test for PRs

on:
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Login to DockerHub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}

            -   name: Build Strapi and Next.js images
                run: |
                    docker buildx build --platform linux/amd64 \
                      -t portefolio-strapi:test \
                      -f ./docker/strapi/Dockerfile \
                      --load .
                    docker buildx build --platform linux/amd64 \
                      -t portefolio-nextjs:test \
                      -f ./docker/nextjs/Dockerfile \
                      --load .

            -   name: Start services with Docker Compose
                run: |
                    docker compose -f docker-compose.ci.yml up -d

            -   name: Wait for services to be ready
                run: |
                    echo "Waiting for services to start..."
                    sleep 10  # Attendre quelques secondes pour laisser Strapi et Next.js d√©marrer
                    docker ps

            -   name: Run Playwright tests inside Next.js container
                id: tests
                run: |
                    docker exec portefolio-nextjs-1 npx playwright test
            
            -   name: Publish Test Summary Results
                run: npx github-actions-ctrf report/test-results.json

            -   name: Stop and clean up
                run: |
                    docker compose -f docker-compose.ci.yml down -v
