name: CI Test for PRs

on:
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Login to DockerHub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}

            -   name: Create missing .env files
                run: |
                    cp .env.dist .env
                    cp nextjs/.env.dist nextjs/.env
                    cp strapi/.env.dist strapi/.env
                    echo "APP_KEYS=myKeyA,myKeyB" >> strapi/.env
                    echo "JWT_SECRET=your_random_secret_key" >> strapi/.env

            -   name: Install dependencies
                run: |
                    corepack enable
                    corepack prepare yarn@stable --activate
                    cd nextjs
                    yarn install
                    cd ../strapi
                    npm install

            -   name: Start services
                run: docker compose -f compose.yml up -d

            -   name: Sleep for 30 seconds
                run: sleep 10

            -   name: Vérifier les containers en cours d'exécution
                run: docker ps -a

            -   name: Logs docker containers for debugging
                run: docker logs portefolio-strapi-1

            -   name: Run Playwright tests inside Next.js container
                id: tests
                run: |
                    docker exec portefolio-nextjs-1 npx playwright test
                    mkdir -p test-results
                    docker cp portefolio-nextjs-1:/app/ctrf/ctrf-report.json test-results/
            
            -   name: Publish Test Summary Results
                run: npx github-actions-ctrf test-results/ctrf-report.json

            -   name: Stop and clean up
                run: |
                    docker compose -f docker-compose.ci.yml down -v

    auto-merge:
        needs: test
        runs-on: ubuntu-latest
        if: github.actor == 'renovate[bot]'
        steps:
            - name: Enable auto-merge for Renovate PRs
              run: gh pr merge --auto --squash "$GITHUB_REF"
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT }}

                    
                    
